<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrancheTrack</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>

<div class="app-layout">
  <main class="main-content">
    <div class="container">
      <header>
        <h1>TrancheTrack</h1>
        <div class="header-actions">
          <span class="timestamp" id="lastRefresh">Loading prices…</span>
          <button class="btn-primary" id="refreshBtn" onclick="refreshPrices()">Refresh Prices</button>
          <button onclick="openAddTranche()">+ Add Tranche</button>
          <button onclick="toggleSidebar()" id="alertsBtn">Alerts</button>
          <button onclick="openSettings()">Settings</button>
        </div>
      </header>

      <div id="loadingMsg"></div>
      <div id="errorMsg"></div>

      <!-- Sort / Filter bar -->
      <div class="filter-bar">
        <div class="filter-group">
          <label for="filterTicker">Ticker</label>
          <select id="filterTicker" onchange="applyFilters()">
            <option value="">All</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="sortField">Sort by</label>
          <select id="sortField" onchange="applyFilters()">
            <option value="ticker">Ticker (default)</option>
            <option value="date-desc">Date (newest first)</option>
            <option value="date-asc">Date (oldest first)</option>
            <option value="price-desc">Purchase Price (high to low)</option>
            <option value="price-asc">Purchase Price (low to high)</option>
            <option value="pnl-desc">P&amp;L (best first)</option>
            <option value="pnl-asc">P&amp;L (worst first)</option>
            <option value="alpha-desc">Alpha (highest first)</option>
            <option value="alpha-asc">Alpha (lowest first)</option>
            <option value="days-desc">Days Held (longest first)</option>
            <option value="days-asc">Days Held (shortest first)</option>
          </select>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Purchase Date</th>
              <th class="num">Purchase Price</th>
              <th class="num">Current Price</th>
              <th class="num">Days Held</th>
              <th class="num">P&amp;L</th>
              <th class="num">% P&amp;L</th>
              <th class="num">Ann. % P&amp;L</th>
              <th class="num">SPY (Buy)</th>
              <th class="num">SPY (Now)</th>
              <th class="num">SPY % P&amp;L</th>
              <th class="num">SPY Ann. %</th>
              <th class="num">Ann. Alpha</th>
              <th class="num">Oscillator</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="15" class="no-data">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Alerts Sidebar -->
  <aside class="alerts-sidebar" id="alertsSidebar">
    <div class="sidebar-header">
      <h2>Alerts</h2>
      <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
    </div>
    <div class="sidebar-content" id="alertsContainer">
      <div class="sidebar-empty">Click <strong>Refresh Prices</strong> to generate alerts.</div>
    </div>
  </aside>
</div>

<!-- Settings Overlay -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel">
    <h2>Settings</h2>
    <div class="key-status" id="keyStatus"></div>
    <label for="apiKeyInput">Polygon.io API Key Override</label>
    <input type="text" id="apiKeyInput" placeholder="Enter your Polygon.io API key">
    <hr class="settings-divider">
    <label class="theme-toggle">
      <span class="theme-label">Dark mode</span>
      <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
      <span class="toggle-track"></span>
    </label>
    <hr class="settings-divider">
    <div class="threshold-section">
      <h3>Alert Thresholds</h3>
      <p class="threshold-desc">Set buy/trim trigger levels per ticker (% from avg cost basis).</p>
      <div id="thresholdInputs"></div>
      <button class="btn-danger btn-sm" onclick="resetThresholds()" style="margin-top:8px">Reset Thresholds</button>
    </div>
    <div class="settings-actions">
      <button class="btn-danger btn-sm" onclick="resetApiKey()">Reset API Key</button>
      <button onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<!-- Add Tranche Overlay -->
<div class="add-tranche-overlay" id="addTrancheOverlay" onclick="if(event.target===this)closeAddTranche()">
  <div class="add-tranche-panel">
    <h2>Add New Tranche</h2>
    <div class="form-row">
      <label for="inputTicker">Ticker Symbol</label>
      <input type="text" id="inputTicker" placeholder="e.g. AAPL">
    </div>
    <div class="form-row">
      <label for="inputDate">Purchase Date</label>
      <input type="text" id="inputDate" placeholder="MM/DD/YYYY">
    </div>
    <div class="form-row">
      <label for="inputPrice">Purchase Price ($)</label>
      <input type="number" id="inputPrice" step="0.01" placeholder="0.00">
    </div>
    <div class="form-row">
      <label for="inputSpyPrice">SPY Price on Purchase Date ($)</label>
      <input type="number" id="inputSpyPrice" step="0.01" placeholder="0.00">
    </div>
    <div class="form-actions">
      <button onclick="closeAddTranche()">Cancel</button>
      <button class="btn-primary" onclick="addTranche()">Add Tranche</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script src="scripts/constants.js"></script>
<script src="scripts/application.js"></script>
</body>
</html>
